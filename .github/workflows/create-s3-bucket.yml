name: Create S3 Bucket on New Branch

on:
  create: # Trigger when a new branch is created
    branches:
      - "*"
workflow_dispatch:
jobs:
  create-s3-bucket:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Configure AWS credentials
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ vars.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}

    # Step 3: Create an S3 bucket with the branch name
    - name: Create S3 bucket
      run: |
        # Generate a valid bucket name from the branch name
        BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9.-')
        BUCKET_NAME="${BRANCH_NAME}-myproject" # Adjust the suffix/prefix as needed
        echo "Creating bucket: $BUCKET_NAME"
        aws s3api create-bucket --bucket "$BUCKET_NAME" --region ${{ vars.AWS_REGION }} \
          --create-bucket-configuration LocationConstraint=${{ vars.AWS_REGION }}
        echo "Bucket successfully created: $BUCKET_NAME"

